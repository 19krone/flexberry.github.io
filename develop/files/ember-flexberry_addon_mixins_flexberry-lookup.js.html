<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>ember-flexberry/addon/mixins/flexberry-lookup.js - Flexberry Documentation</title>
    <link rel="stylesheet" href="">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="stylesheet" href="../assets/css/custom.css">
    <link rel="stylesheet" href="../assets/vendor/bootstrap/css/bootstrap.css">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
</head>
<body class="yui3-skin-sam">
<div class="navbar navbar-fixed-top">
    <div class="navbar-inner">
        <h1 class="brand" style="padding: 10px 16px 10px; height: 20px; line-height: 20px; margin-left: 0;">
	    <img alt="Flexberry Documentation" src="../assets/css/logo.png" style="max-height: 65%;" title="Flexberry Documentation">
            Flexberry Documentation
        </h1>
	<div class="nav">
            <li class="divider-vertical"></li>
            <li>
                <p class="navbar-text">
                    API Docs for Version: <b>develop</b>
                </p>
            </li>
        </div>
        <form class="navbar-form pull-right" style="line-height: 40px; height: 40px;">
            <input style="margin-top: 0;" type="text" class="search-query" placeholder="Search for classes/modules..." data-obj='["classes/BaseModel", "classes/DetailEditFormController", "classes/DetailInterationService", "classes/DeviceService", "classes/DS.ODataAdapter", "classes/DS.Projection", "classes/EditFormController", "classes/EditFormRoute", "classes/FileTransform", "classes/FlexberrCheckboxComponent", "classes/FlexberryBaseComponent", "classes/FlexberryDatetimePicker", "classes/FlexberryDropDown", "classes/FlexberryField", "classes/FlexberryFile", "classes/FlexberryFileController", "classes/FlexberryGroupedit", "classes/FlexberryLookup", "classes/FlexberryLookupCompatibleComponentMixin", "classes/FlexberryLookupMixin", "classes/FlexberryMenuComponent", "classes/FlexberryMenuitemComponent", "classes/FlexberryObjectlistview", "classes/FlexberrySimpledatetime", "classes/FlexberryTextarea", "classes/FlexberryTextbox", "classes/FlexberryToggler", "classes/FlexberryValidationmessage", "classes/FlexberryValidationsummary", "classes/GroupEditToolbar", "classes/isEnum", "classes/ListFormController", "classes/ListFormRoute", "classes/ModalDialog", "classes/ObjectListView", "classes/ObjectListViewCell", "classes/ObjectlistviewEvents", "classes/ObjectListViewHeaderCell", "classes/ObjectListViewSingleColumnCell", "classes/Query.BaseAdapter", "classes/Query.BaseBuilder", "classes/Query.BasePredicate", "classes/Query.Builder", "classes/Query.ComplexPredicate", "classes/Query.Condition", "classes/Query.FilterOperator", "classes/Query.IndexedDbAdapter", "classes/Query.JSAdapter", "classes/Query.ODataAdapter", "classes/Query.OrderByClause", "classes/Query.SimplePredicate", "classes/Query.StringPredicate", "classes/ReloadListMixin", "classes/Resolver", "classes/Serializer.Base", "classes/Serializer.OData", "modules/ember-flexberry", "modules/ember-flexberry-data"]'>
        </form>
    </div>
</div>
<div class="container">
    <div class="row">
        <div class="span3">
	    <div>
	        <h3>APIs</h3>
	        <div id="sidebar">
	            <ul id="main-nav" class="nav nav-tabs" style="margin-bottom:0;">
	                <li class="active"><a href="#classes" data-toggle="tab">Classes</a></li>
	                <li><a href="#modules" data-toggle="tab">Modules</a></li>
	            </ul>
	    
	            <div id="api-tabview-filter">
	                <input type="search" placeholder="Type to filter APIs">
	            </div>
	    
	            <div class="tab-content" style="border: 1px solid #DDD; border-top:0;">
	                <div class="tab-pane active" id="classes">
	                    <ul id="api-classes" class="nav nav-list">
	                            <li><a href="../classes/BaseModel.html">BaseModel</a></li>
	                            <li><a href="../classes/DetailEditFormController.html">DetailEditFormController</a></li>
	                            <li><a href="../classes/DetailInterationService.html">DetailInterationService</a></li>
	                            <li><a href="../classes/DeviceService.html">DeviceService</a></li>
	                            <li><a href="../classes/DS.ODataAdapter.html">DS.ODataAdapter</a></li>
	                            <li><a href="../classes/DS.Projection.html">DS.Projection</a></li>
	                            <li><a href="../classes/EditFormController.html">EditFormController</a></li>
	                            <li><a href="../classes/EditFormRoute.html">EditFormRoute</a></li>
	                            <li><a href="../classes/FileTransform.html">FileTransform</a></li>
	                            <li><a href="../classes/FlexberrCheckboxComponent.html">FlexberrCheckboxComponent</a></li>
	                            <li><a href="../classes/FlexberryBaseComponent.html">FlexberryBaseComponent</a></li>
	                            <li><a href="../classes/FlexberryDatetimePicker.html">FlexberryDatetimePicker</a></li>
	                            <li><a href="../classes/FlexberryDropDown.html">FlexberryDropDown</a></li>
	                            <li><a href="../classes/FlexberryField.html">FlexberryField</a></li>
	                            <li><a href="../classes/FlexberryFile.html">FlexberryFile</a></li>
	                            <li><a href="../classes/FlexberryFileController.html">FlexberryFileController</a></li>
	                            <li><a href="../classes/FlexberryGroupedit.html">FlexberryGroupedit</a></li>
	                            <li><a href="../classes/FlexberryLookup.html">FlexberryLookup</a></li>
	                            <li><a href="../classes/FlexberryLookupCompatibleComponentMixin.html">FlexberryLookupCompatibleComponentMixin</a></li>
	                            <li><a href="../classes/FlexberryLookupMixin.html">FlexberryLookupMixin</a></li>
	                            <li><a href="../classes/FlexberryMenuComponent.html">FlexberryMenuComponent</a></li>
	                            <li><a href="../classes/FlexberryMenuitemComponent.html">FlexberryMenuitemComponent</a></li>
	                            <li><a href="../classes/FlexberryObjectlistview.html">FlexberryObjectlistview</a></li>
	                            <li><a href="../classes/FlexberrySimpledatetime.html">FlexberrySimpledatetime</a></li>
	                            <li><a href="../classes/FlexberryTextarea.html">FlexberryTextarea</a></li>
	                            <li><a href="../classes/FlexberryTextbox.html">FlexberryTextbox</a></li>
	                            <li><a href="../classes/FlexberryToggler.html">FlexberryToggler</a></li>
	                            <li><a href="../classes/FlexberryValidationmessage.html">FlexberryValidationmessage</a></li>
	                            <li><a href="../classes/FlexberryValidationsummary.html">FlexberryValidationsummary</a></li>
	                            <li><a href="../classes/GroupEditToolbar.html">GroupEditToolbar</a></li>
	                            <li><a href="../classes/isEnum.html">isEnum</a></li>
	                            <li><a href="../classes/ListFormController.html">ListFormController</a></li>
	                            <li><a href="../classes/ListFormRoute.html">ListFormRoute</a></li>
	                            <li><a href="../classes/ModalDialog.html">ModalDialog</a></li>
	                            <li><a href="../classes/ObjectListView.html">ObjectListView</a></li>
	                            <li><a href="../classes/ObjectListViewCell.html">ObjectListViewCell</a></li>
	                            <li><a href="../classes/ObjectlistviewEvents.html">ObjectlistviewEvents</a></li>
	                            <li><a href="../classes/ObjectListViewHeaderCell.html">ObjectListViewHeaderCell</a></li>
	                            <li><a href="../classes/ObjectListViewSingleColumnCell.html">ObjectListViewSingleColumnCell</a></li>
	                            <li><a href="../classes/Query.BaseAdapter.html">Query.BaseAdapter</a></li>
	                            <li><a href="../classes/Query.BaseBuilder.html">Query.BaseBuilder</a></li>
	                            <li><a href="../classes/Query.BasePredicate.html">Query.BasePredicate</a></li>
	                            <li><a href="../classes/Query.Builder.html">Query.Builder</a></li>
	                            <li><a href="../classes/Query.ComplexPredicate.html">Query.ComplexPredicate</a></li>
	                            <li><a href="../classes/Query.Condition.html">Query.Condition</a></li>
	                            <li><a href="../classes/Query.FilterOperator.html">Query.FilterOperator</a></li>
	                            <li><a href="../classes/Query.IndexedDbAdapter.html">Query.IndexedDbAdapter</a></li>
	                            <li><a href="../classes/Query.JSAdapter.html">Query.JSAdapter</a></li>
	                            <li><a href="../classes/Query.ODataAdapter.html">Query.ODataAdapter</a></li>
	                            <li><a href="../classes/Query.OrderByClause.html">Query.OrderByClause</a></li>
	                            <li><a href="../classes/Query.SimplePredicate.html">Query.SimplePredicate</a></li>
	                            <li><a href="../classes/Query.StringPredicate.html">Query.StringPredicate</a></li>
	                            <li><a href="../classes/ReloadListMixin.html">ReloadListMixin</a></li>
	                            <li><a href="../classes/Resolver.html">Resolver</a></li>
	                            <li><a href="../classes/Serializer.Base.html">Serializer.Base</a></li>
	                            <li><a href="../classes/Serializer.OData.html">Serializer.OData</a></li>
	                    </ul>
	                </div>
	    
	                <div class="tab-pane" id="modules">
	                    <ul id="api-modules" class="nav nav-list">
	                            <li><a href="../modules/ember-flexberry.html">ember-flexberry</a></li>
	                            <li><a href="../modules/ember-flexberry-data.html">ember-flexberry-data</a></li>
	                    </ul>
	                </div>
	            </div>
	        </div>
	    </div>
        </div>
        <div class="span9">
                <form id="options-form" class="form-inline pull-right">
                    Show:
                    <label for="api-show-inherited" class="checkbox">
                        <input type="checkbox" id="api-show-inherited" checked>
                        Inherited
                    </label>
            
                    <label for="api-show-protected" class="checkbox">
                        <input type="checkbox" id="api-show-protected">
                        Protected
                    </label>
            
                    <label for="api-show-private" class="checkbox">
                        <input type="checkbox" id="api-show-private">
                        Private
                    </label>
                    <label for="api-show-deprecated" class="checkbox">
                        <input type="checkbox" id="api-show-deprecated">
                        Deprecated
                    </label>
            
                </form>
            
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
<div class="page-header">
    <h1>ember-flexberry/addon/mixins/flexberry-lookup.js <small>File</small></h1>
</div>

<div class="file">
    <pre class="prettyprint linenums">
/**
 * @module ember-flexberry
 */

import Ember from &#x27;ember&#x27;;

import ReloadListMixin from &#x27;../mixins/reload-list-mixin&#x27;;

import { BasePredicate } from &#x27;ember-flexberry-data/query/predicate&#x27;;

/**
 * Mixin for {{#crossLink &quot;DS.Controller&quot;}}Controller{{/crossLink}} to support work with modal windows at lookups.
 *
 * @class FlexberryLookupMixin
 * @extends Ember.Mixin
 * @uses ReloadListMixin
 * @public
 */
export default Ember.Mixin.create(ReloadListMixin, {
  /**
   * Lookup settings for modal window.
   * It has to be overriden on controller where this mixin is used.
   *
   * @property lookupSettings
   * @type Object
   */
  lookupSettings: {
    /**
     * Name of controller that handles modal window.
     * Controller with the same name has to be injected to property &#x60;lookupController&#x60;.
     *
     * @property controllerName
     * @type String
     * @default undefined
     */
    controllerName: undefined,

    /**
     * Name of template for modal window itself (not content of modal window).
     *
     * @property template
     * @type String
     * @default undefined
     */
    template: undefined,

    /**
     * Name of template for content of modal window.
     *
     * @property contentTemplate
     * @type String
     * @default undefined
     */
    contentTemplate: undefined,

    /**
     * Name of template for content of loading modal window.
     *
     * @property loaderTemplate
     * @type String
     * @default undefined
     */
    loaderTemplate: undefined
  },

  /**
   * Controller to show lookup modal window.
   *
   * @property lookupController
   * @type Ember.InjectedProperty
   * @default undefined
   */
  lookupController: undefined,

  /**
   * Default number of records per page on lookup window list.
   *
   * @property lookupModalWindowPerPage
   * @type Number
   * @default 5
   */
  lookupModalWindowPerPage: 5,

  actions: {
    /**
     * Handles action from lookup choose action.
       It opens modal window where availible values are shown.

       In order to customize content of all lookup modal window there is such a way:
       1) create template with necessary content and set unique name for it (for example &#x27;customlookupform.hbs&#x27;);
       2) override lookup setting &#x60;lookupSettings.contentTemplate&#x60; on controller level (for example &#x27;customlookupform&#x27;);
       3) if there has to be specific logic or properties on controller for template,
          current lookup controller can be overriden (it is &#x27;lookup-dialog&#x27; for edit forms),
          new name can be set on lookup setting &#x60;lookupSettings.controllerName&#x60;
          and new controller can be injected as &#x60;lookupController&#x60;
          (if the controller was extended and not reopened).

     * @method showLookupDialog
     * @param {Object} chooseData Lookup parameters (projection name, relation name, etc).
     */
    showLookupDialog: function(chooseData) {
      let options = Ember.$.extend(true, {
        projection: undefined,
        relationName: undefined,
        title: undefined,
        predicate: undefined,
        modelToLookup: undefined,
        sizeClass: undefined,
        lookupWindowCustomPropertiesData: undefined
      }, chooseData);

      let projectionName = options.projection;
      Ember.assert(&#x27;ProjectionName is undefined.&#x27;, projectionName);

      let limitPredicate = options.predicate;
      if (limitPredicate &amp;&amp; !(limitPredicate instanceof BasePredicate)) {
        throw new Error(&#x27;Limit predicate is not correct. It has to be instance of BasePredicate.&#x27;);
      }

      let relationName = options.relationName;
      let title = options.title;
      let modelToLookup = options.modelToLookup;
      let lookupWindowCustomPropertiesData = options.lookupWindowCustomPropertiesData;
      let sizeClass = options.sizeClass;

      let model = modelToLookup ? modelToLookup : this.get(&#x27;model&#x27;);

      // Get ember static function to get relation by name.
      let relationshipsByName = Ember.get(model.constructor, &#x27;relationshipsByName&#x27;);

      // Get relation property from model.
      let relation = relationshipsByName.get(relationName);
      if (!relation) {
        throw new Error(&#x60;No relation with &#x27;${relationName}&#x27; name defined in &#x27;${model.constructor.modelName}&#x27; model.&#x60;);
      }

      // Get property type name.
      let relatedToType = relation.type;

      // Lookup
      var lookupSettings = this.get(&#x27;lookupSettings&#x27;);
      Ember.assert(&#x27;Lookup settings are undefined.&#x27;, lookupSettings);

      let reloadData = {
        initialLoad: true,
        relatedToType: relatedToType,
        projectionName: projectionName,

        perPage: this.get(&#x27;lookupModalWindowPerPage&#x27;),
        page: 1,
        sorting: [],
        filter: undefined,
        predicate: limitPredicate,

        title: title,
        sizeClass: sizeClass,
        saveTo: {
          model: model,
          propName: relationName
        },
        currentLookupRow: model.get(relationName),
        customPropertiesData: lookupWindowCustomPropertiesData
      };

      this._reloadModalData(this, reloadData);
    },

    /**
     * Handles correcponding route&#x27;s willTransition action.
     * It sends message about transition to showing lookup modal window controller.
     *
     * @method routeWillTransition
     */
    routeWillTransition: function() {
      this.get(&#x27;lookupController&#x27;).send(&#x27;routeWillTransition&#x27;);
    },

    /**
     * Handles action from lookup remove action.
     *
     * @method removeLookupValue
     * @param {Object} removeData Lookup parameters (projection name, etc).
     */
    removeLookupValue: function(removeData) {
      let options = Ember.$.extend(true, {
        relationName: undefined,
        modelToLookup: undefined
      }, removeData);
      let relationName = options.relationName;
      let modelToLookup = options.modelToLookup;

      let model = modelToLookup ? modelToLookup : this.get(&#x27;model&#x27;);
      model.set(relationName, undefined);

      // Manually make record dirty, because ember-data does not do it when relationship changes.
      model.makeDirty();
    },

    /**
     * Update relation value at model.
     *
     * @method updateLookupValue
     * @param {Object} updateData Lookup parameters to update data at model (projection name, etc).
     */
    updateLookupValue: function(updateData) {
      let options = Ember.$.extend(true, {
        relationName: undefined,
        newRelationValue: undefined,
        modelToLookup: undefined
      }, updateData);
      let modelToLookup = options.modelToLookup;
      let model = modelToLookup ? modelToLookup : this.get(&#x27;model&#x27;);

      Ember.Logger.debug(&#x60;Flexberry Lookup Mixin::updateLookupValue ${options.relationName}&#x60;);
      model.set(options.relationName, options.newRelationValue);

      // Manually make record dirty, because ember-data does not do it when relationship changes.
      model.makeDirty();
    }
  },

  /**
   * This method refreshes displayed data on lookup modal window.

     It reloads current lookup modal window in order to show loading image.
     Then proper request to load data is formed (it considers current page, filter, etc).
     After the data loading data are displayed on lookup modal window.

     This method is called during the first data loading
     and after each change of request parameters (current page, filter, etc) on lookup modal window controller
     (it is implemented by sending handler on this method to lookup modal window controller).

   * @method _reloadModalData
   * @private
   *
   * @param {String} currentContext Current execution context of this method.
   * @param {Object} options Parameters to load proper data and to tune modal lookup window outlook.
   * @param {String} [options.relatedToType] Type of records to load.
   * @param {String} [options.projectionName] Projection name to load data by.
   * @param {String} [options.perPage] Number of records to display on page.
   * @param {String} [options.page] Current page to display on lookup window.
   * @param {String} [options.sorting] Current sorting.
   * @param {String} [options.filter] Current filter.
   * @param {String} [options.predicate] Current limit predicate.
   * @param {String} [options.title] Title of modal lookup window.
   * @param {String} [options.sizeClass] Size of modal lookup window.
   * @param {String} [options.saveTo] Options to save selected lookup value.
   * @param {String} [options.currentLookupRow] Current lookup value.
   * @param {String} [options.customPropertiesData] Custom properties of modal lookup window.
   */
  _reloadModalData: function(currentContext, options) {
    var lookupSettings = currentContext.get(&#x27;lookupSettings&#x27;);
    Ember.assert(&#x27;Lookup settings are undefined.&#x27;, lookupSettings);
    Ember.assert(&#x27;Lookup template is undefined.&#x27;, lookupSettings.template);
    Ember.assert(&#x27;Lookup content template is undefined.&#x27;, lookupSettings.contentTemplate);
    Ember.assert(&#x27;Lookup loader template is undefined.&#x27;, lookupSettings.loaderTemplate);

    let reloadData = Ember.merge({
      initialLoad: false,
      relatedToType: undefined,
      projectionName: undefined,

      perPage: undefined,
      page: undefined,
      sorting: undefined,
      filter: undefined,
      predicate: undefined,

      title: undefined,
      sizeClass: undefined,
      saveTo: undefined,
      currentLookupRow: undefined,
      customPropertiesData: undefined
    }, options);

    Ember.assert(&#x27;Reload data are not defined fully.&#x27;,
      reloadData.relatedToType ||
      reloadData.projectionName ||
      reloadData.projection ||
      reloadData.saveTo);

    let modelConstructor = currentContext.store.modelFor(reloadData.relatedToType);
    let projection = Ember.get(modelConstructor, &#x27;projections&#x27;)[reloadData.projectionName];
    if (!projection) {
      throw new Error(
        &#x60;No projection with &#x27;${reloadData.projectionName}&#x27; name defined in &#x27;${reloadData.relatedToType}&#x27; model.&#x60;);
    }

    let limitPredicate = reloadData.predicate;
    if (limitPredicate &amp;&amp; !(limitPredicate instanceof BasePredicate)) {
      throw new Error(&#x27;Limit predicate is not correct. It has to be instance of BasePredicate.&#x27;);
    }

    let queryParameters = {
      modelName: reloadData.relatedToType,
      projectionName: reloadData.projectionName,
      perPage: reloadData.perPage ? reloadData.perPage : this.get(&#x27;lookupModalWindowPerPage&#x27;),
      page: reloadData.page ? reloadData.page : 1,
      sorting: reloadData.sorting ? reloadData.sorting : [],
      filter: reloadData.filter,
      predicate: limitPredicate
    };

    let controller = currentContext.get(&#x27;lookupController&#x27;);
    controller.clear(reloadData.initialLoad);
    controller.setProperties({
      modelProjection: projection,
      title: reloadData.title,
      sizeClass: reloadData.sizeClass,
      saveTo: reloadData.saveTo,
      currentLookupRow: reloadData.currentLookupRow,
      customPropertiesData: reloadData.customPropertiesData,

      perPage: queryParameters.perPage,
      page: queryParameters.page,
      filter: reloadData.filter,
      predicate: limitPredicate,

      modelType: reloadData.relatedToType,
      projectionName: reloadData.projectionName,
      reloadContext: currentContext,
      reloadDataHandler: currentContext._reloadModalData
    });

    if (reloadData.initialLoad) {
      currentContext.send(&#x27;showModalDialog&#x27;, lookupSettings.template);
    }

    controller.set(&#x27;reloadObserverIsActive&#x27;, true);

    var loadingParams = {
      view: lookupSettings.template,
      outlet: &#x27;modal-content&#x27;
    };
    currentContext.send(&#x27;showModalDialog&#x27;, lookupSettings.loaderTemplate, null, loadingParams);

    currentContext.reloadList(queryParameters).then(data =&gt; {
      data.set(&#x27;sorting&#x27;, queryParameters.sorting);
      currentContext.send(&#x27;removeModalDialog&#x27;, loadingParams);
      currentContext.send(&#x27;showModalDialog&#x27;, lookupSettings.contentTemplate, {
        controller: controller,
        model: data
      }, loadingParams);
    });
  }
});

    </pre>
</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/jquery/jquery-1.8.2.min.js"></script>
<script src="../assets/vendor/bootstrap/js/bootstrap.js"></script>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script src="../assets/js/yuidoc-bootstrap.js"></script>
<script>prettyPrint();</script>
</body>
</html>
